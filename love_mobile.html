import tkinter as tk
from tkinter import messagebox
import random


def main():
    root = tk.Tk()
    root.title("Valentine's Day")
    root.geometry("520x320")
    root.resizable(False, False)

    # Soft Valentine styling
    bg = "#ffc0d9"          # baby pink
    panel = "#ffe6f0"       # very light pink panel
    text = "#3b2f2f"
    accent = "#ff4d8d"
    danger = "#cc0000"
    ui_font = ("Segoe UI", 18, "bold")
    ui_font_small = ("Segoe UI", 12)
    ui_btn_font = ("Segoe UI", 14, "bold")

    root.configure(bg=bg)

    def round_rect(canvas, x1, y1, x2, y2, r, **kwargs):
        points = [
            x1 + r, y1,
            x2 - r, y1,
            x2, y1,
            x2, y1 + r,
            x2, y2 - r,
            x2, y2,
            x2 - r, y2,
            x1 + r, y2,
            x1, y2,
            x1, y2 - r,
            x1, y1 + r,
            x1, y1,
        ]
        return canvas.create_polygon(points, smooth=True, **kwargs)

    # ---- Personalized start screen ----
    start_canvas = tk.Canvas(root, width=440, height=210, bg=bg, highlightthickness=0, bd=0)
    start_canvas.pack(pady=35)
    round_rect(start_canvas, 10, 10, 430, 200, 22, fill=panel, outline="#ff9fc2", width=2)

    start_frame = tk.Frame(start_canvas, bg=panel)
    start_canvas.create_window(220, 105, window=start_frame)

    start_title = tk.Label(
        start_frame,
        text="Valentine Setup ğŸ’–",
        font=("Segoe UI", 16, "bold"),
        bg=panel,
        fg=text,
    )
    start_title.pack(pady=(12, 6))

    start_sub = tk.Label(
        start_frame,
        text="Enter Your Name:",
        font=("Times New Roman", 11),
        bg=panel,
        fg=text,
    )
    start_sub.pack(pady=(0, 10))

    name_var = tk.StringVar()
    name_entry = tk.Entry(
        start_frame,
        textvariable=name_var,
        font=("Segoe UI", 12),
        width=24,
        justify="center",
        relief="solid",
        bd=1,
    )
    name_entry.pack(pady=(0, 10))
    name_entry.focus_set()

    def build_main_ui(person_name: str):
        # Clear the start UI
        start_canvas.destroy()

        person_name = (person_name or "").strip()
        person_prefix = f"{person_name}, " if person_name else ""

        # Background animation canvas for floating hearts/emojis (create first, behind everything)
        bg_anim = tk.Canvas(root, width=520, height=320, bg=bg, highlightthickness=0, bd=0)
        bg_anim.place(x=0, y=0)

        # Floating hearts and emojis
        floating_items = []
        emojis = ["ğŸ’–", "ğŸ’•", "ğŸ’—", "ğŸ’“", "ğŸ’", "ğŸ’", "ğŸ˜š", "â˜ºï¸", "ğŸ¥°", "ğŸ˜", "ğŸ’‹", "ğŸŒ¹", "âœ¨", "â­"]
        
        def create_floating_item():
            x = random.randint(20, 500)
            y = random.randint(300, 350)
            emoji = random.choice(emojis)
            size = random.randint(16, 24)
            item = bg_anim.create_text(x, y, text=emoji, font=("Segoe UI", size), fill=random.choice(["#ff4d8d", "#ff2f78", "#ff6ba3", "#ff9fc2"]))
            floating_items.append({"id": item, "x": x, "y": y, "speed": random.uniform(0.5, 1.5), "drift": random.uniform(-0.5, 0.5)})
            # Schedule next item creation
            root.after(random.randint(800, 2000), create_floating_item)

        def animate_floating():
            for item_data in floating_items[:]:
                item_id = item_data["id"]
                try:
                    # Move upward
                    item_data["y"] -= item_data["speed"]
                    # Add slight horizontal drift
                    item_data["x"] += item_data["drift"]
                    bg_anim.coords(item_id, item_data["x"], item_data["y"])
                    
                    # Remove if off screen
                    if item_data["y"] < -30:
                        bg_anim.delete(item_id)
                        floating_items.remove(item_data)
                except:
                    if item_data in floating_items:
                        floating_items.remove(item_data)
            
            root.after(30, animate_floating)

        # Start creating floating items
        for _ in range(8):
            root.after(random.randint(0, 2000), create_floating_item)
        animate_floating()

        title = tk.Label(
            root,
            text=f"{person_prefix}will you be my Valentine ğŸ˜š",
            font=ui_font,
            pady=30,
            bg=bg,
            fg=text,
        )
        title.pack()

        subtitle = tk.Label(
            root,
            text="Choose one:",
            font=ui_font_small,
            bg=bg,
            fg=text,
        )
        subtitle.pack()

        # Rounded-corner panel behind the buttons (tkinter doesn't support rounded Frames)
        panel_canvas = tk.Canvas(root, width=420, height=120, bg=bg, highlightthickness=0, bd=0)
        panel_canvas.pack(pady=25)
        round_rect(panel_canvas, 10, 10, 410, 110, 22, fill=panel, outline="#ff9fc2", width=2)

        buttons_frame = tk.Frame(panel_canvas, bg=panel)
        panel_canvas.create_window(210, 60, window=buttons_frame)

        no_cross_visible = {"value": False}  # cross appears only after NO is pressed

        def on_yes():
            win = tk.Toplevel(root)
            win.title("Congrats!")
            win.geometry("520x320")
            win.resizable(False, False)
            win.configure(bg=bg)

            # Background animation canvas (create first so everything else appears above it)
            anim = tk.Canvas(win, width=520, height=320, bg=bg, highlightthickness=0)
            anim.place(x=0, y=0)

            header = tk.Label(
                win,
                text=f"CONGRATS! ğŸ‰ you are my valentine!!! ğŸ’–",
                font=("Segoe UI", 16, "bold"),
                bg=bg,
                fg=text,
                pady=10,
            )
            header.pack()

            # Rounded panel helper for the "Yes" window
            def make_rounded_panel(parent, w, h, fill, outline):
                c = tk.Canvas(parent, width=w, height=h, bg=bg, highlightthickness=0, bd=0)
                c.pack(pady=10)
                round_rect(c, 10, 10, w - 10, h - 10, 22, fill=fill, outline=outline, width=2)
                inner = tk.Frame(c, bg=fill)
                c.create_window(w // 2, h // 2, window=inner)
                return inner

            step_panel = make_rounded_panel(win, 480, 220, panel, "#ff9fc2")

            step_title = tk.Label(
                step_panel,
                text="Pick a mystery gift ğŸ",
                font=("Segoe UI", 13, "bold"),
                bg=panel,
                fg=text,
            )
            step_title.pack(pady=(12, 6))

            gifts_row = tk.Frame(step_panel, bg=panel)
            gifts_row.pack(pady=6)

            reveal_text = tk.StringVar(value="(Choose one box to reveal your surprise!)")
            reveal_label = tk.Label(
                step_panel,
                textvariable=reveal_text,
                font=("Segoe UI", 11),
                bg=panel,
                fg=text,
                wraplength=430,
                justify="center",
            )
            reveal_label.pack(pady=(6, 10))

            final_text = tk.StringVar(value="")
            final_label = tk.Label(
                step_panel,
                textvariable=final_text,
                font=("Segoe UI", 11),
                bg=panel,
                fg=text,
                wraplength=430,
                justify="center",
            )

            hearts = []
            confetti = []
            for _ in range(12):
                x = random.randint(20, 500)
                y = random.randint(160, 310)
                hearts.append(anim.create_text(x, y, text="ğŸ’–", font=("Segoe UI", 18)))
            for _ in range(14):
                x = random.randint(10, 510)
                y = random.randint(10, 310)
                confetti.append(anim.create_text(x, y, text="ğŸ‰", font=("Segoe UI", 16)))

            def tick():
                for h in hearts:
                    anim.move(h, 0, -2)
                    _x, y = anim.coords(h)
                    if y < -10:
                        anim.coords(h, random.randint(20, 500), random.randint(260, 330))
                for c in confetti:
                    anim.move(c, random.randint(-2, 2), 2)
                    _x, y = anim.coords(c)
                    if y > 340:
                        anim.coords(c, random.randint(10, 510), random.randint(-30, 0))
                win.after(55, tick)

            tick()

            gift_messages = [
                f"{person_prefix}Tuje pata nhi but tu mere liye bhaut special h.\nM jada express tho nhi kr pata but I love you ğŸ˜š",
                f"{person_prefix}M humesha tera sath dunga, jb bhi tuje meri zarurat hogi I'll be there for you ğŸ’–",
                f"{person_prefix}I love you 24/7/365 days a yearâ˜ºï¸",
            ]

            gift_opened = {"value": False}

            def after_gift_opened():
                # Finish flow after gift is revealed (no date-idea step)
                final_label.pack(pady=(8, 12))

            def reveal_gift(idx):
                if gift_opened["value"]:
                    return
                gift_opened["value"] = True
                reveal_text.set(f"Surprise: {gift_messages[idx]}")
                final_text.set(f"See you soon... {person_name or 'Valentine'} ğŸ˜šâ˜ºï¸")
                for b in gift_buttons:
                    b.configure(state="disabled")
                after_gift_opened()

            gift_buttons = []
            for i in range(3):
                btn = tk.Button(
                    gifts_row,
                    text="ğŸ",
                    font=("Segoe UI", 22),
                    width=3,
                    command=lambda i=i: reveal_gift(i),
                    bg="#ffd1e3",
                    fg=text,
                    activebackground="#ffbfd8",
                    activeforeground=text,
                    relief="raised",
                    bd=4,
                )
                btn.grid(row=0, column=i, padx=12)
                gift_buttons.append(btn)

        def on_no():
            # Show a red cross only AFTER the NO button is pressed
            if not no_cross_visible["value"]:
                no_canvas.itemconfigure(cross1, state="normal")
                no_canvas.itemconfigure(cross2, state="normal")
                no_cross_visible["value"] = True
            messagebox.showerror("Ouch!", "Ouch! it's hurt ğŸ’” try again â˜ºï¸.")

        yes_btn = tk.Button(
            buttons_frame,
            text="Yes",
            font=ui_btn_font,
            width=10,
            command=on_yes,
            bg=accent,
            fg="white",
            activebackground="#ff2f78",
            activeforeground="white",
            relief="raised",
            bd=4,
        )
        yes_btn.grid(row=0, column=0, padx=18)

        # NO button: cross appears only when pressed
        no_canvas = tk.Canvas(
            buttons_frame,
            width=160,
            height=44,
            highlightthickness=0,
            bd=0,
            bg=panel,
        )
        no_canvas.grid(row=0, column=1, padx=18)

        no_btn = tk.Button(
            buttons_frame,
            text="NO",
            font=ui_btn_font,
            width=10,
            command=on_no,
            bg="#ffd1e3",
            fg=text,
            activebackground="#ffbfd8",
            activeforeground=text,
            relief="raised",
            bd=4,
        )

        # Put the button inside the canvas, then prepare a red "X" (hidden until pressed)
        no_canvas.create_window(0, 0, anchor="nw", window=no_btn, width=160, height=44)
        cross1 = no_canvas.create_line(6, 6, 154, 38, fill=danger, width=4, state="hidden")
        cross2 = no_canvas.create_line(154, 6, 6, 38, fill=danger, width=4, state="hidden")
        
        # Ensure background animation canvas stays behind all widgets
        root.update_idletasks()  # Update to ensure all widgets are rendered
        bg_anim.lower()

    def start():
        build_main_ui(name_var.get())

    start_btn = tk.Button(
        start_frame,
        text="Continue ğŸ’",
        font=("Segoe UI", 12, "bold"),
        width=16,
        command=start,
        bg=accent,
        fg="white",
        activebackground="#ff2f78",
        activeforeground="white",
        relief="raised",
        bd=4,
    )
    start_btn.pack(pady=(2, 14))
    name_entry.bind("<Return>", lambda _e: start())

    root.mainloop()


if __name__ == "__main__":
    main()
